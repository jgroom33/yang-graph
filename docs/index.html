<!DOCTYPE html>
<html>

<head>
  <title>YANG Graph Renderer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.1/cytoscape.min.js"></script>
  <style>
    #cy {
      width: 100%;
      height: 800px;
      border: 1px solid #ccc;
      position: relative;
      z-index: 1;
    }

    #node-info {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 300px;
      padding: 10px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
      z-index: 10;
    }

    #search-container {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 10px;
      z-index: 10;
      background-color: #fff;
    }

    #search-input {
      padding: 5px;
      width: 200px;
    }

    .highlighted {
      background-color: #FF4136;
      border-width: 2px;
      border-color: #000;
    }
  </style>
</head>

<body>
  <div id="search-container">
    <input type="text" id="search-input" placeholder="Search nodes by ID...">
    <button onclick="searchNodes()">Search</button>
  </div>
  <div id="cy"></div>
  <div id="node-info">
    <h3>Node Information</h3>
    <p id="node-id">ID: N/A</p>
    <p id="node-module">Module: N/A</p>
    <p id="node-description">Description: N/A</p>
    <p id="node-key">Key: N/A</p>
  </div>
  <script>
    let cy;

    document.addEventListener("DOMContentLoaded", function () {
      fetch("graph.json")
        .then((response) => response.json())
        .then((data) => {
          const elements = data.graph || {
            nodes: data.nodes || [],
            edges: data.edges || [],
          };
          const nodes = (
            data.graph ? elements.filter((e) => e.data.id) : elements.nodes
          ).map((n) => n.data);
          const edges = (
            data.graph ? elements.filter((e) => !e.data.id) : elements.edges
          ).map((e) => e.data);

          const connectedNodeIds = new Set();
          edges.forEach((edge) => {
            connectedNodeIds.add(edge.source);
            connectedNodeIds.add(edge.target);
          });

          const filteredNodes = nodes.filter((node) => connectedNodeIds.has(node.id));
          const nodeIds = new Set(filteredNodes.map((n) => n.id));

          const placeholderNodes = [];
          edges.forEach((edge) => {
            if (!nodeIds.has(edge.target)) {
              placeholderNodes.push({
                id: edge.target,
                type: "unknown",
                module: edge.target.split(":")[0] || "unknown",
                description: "Referenced but not defined in processed YANG modules",
                key: null,
                isPlaceholder: true,
              });
              nodeIds.add(edge.target);
            }
          });

          const allNodes = filteredNodes.concat(placeholderNodes);
          const allElements = allNodes
            .map((n) => ({ data: n }))
            .concat(edges.map((e) => ({ data: e })));

          cy = cytoscape({
            container: document.getElementById("cy"),
            elements: allElements,
            style: [
              {
                selector: "node",
                style: {
                  shape: "roundrectangle",
                  label: "data(id)",
                  "background-color": "#0074D9",
                  color: "#fff",
                  "text-valign": "center",
                  "text-halign": "center",
                  width: "150px",
                  height: "80px",
                  "font-size": "10px",
                  "text-wrap": "wrap",
                  "text-max-width": "140px",
                  padding: "5px",
                },
              },
              {
                selector: "node[isPlaceholder]",
                style: {
                  "background-color": "#999999",
                  opacity: 0.6,
                  label: 'data(id) + " (missing)"',
                },
              },
              {
                selector: "node.highlighted",
                style: {
                  "background-color": "#FF4136",
                  "border-width": "2px",
                  "border-color": "#000",
                },
              },
              {
                selector: 'edge[relationship ^= "references_key"]',
                style: {
                  width: 2,
                  "line-color": "#2ECC40",
                  "target-arrow-color": "#2ECC40",
                  "target-arrow-shape": "triangle",
                  label: "data(relationship)",
                  "font-size": "10px",
                  "curve-style": "bezier",
                },
              },
              {
                selector: 'edge[relationship = "references_type"]',
                style: {
                  width: 2,
                  "line-color": "#FF851B",
                  "target-arrow-color": "#FF851B",
                  "target-arrow-shape": "triangle",
                  label: "data(relationship)",
                  "font-size": "10px",
                  "curve-style": "bezier",
                },
              },
              {
                selector: 'edge[relationship = "references_list"]',
                style: {
                  width: 2,
                  "line-color": "#7FDBFF",
                  "target-arrow-color": "#7FDBFF",
                  "target-arrow-shape": "triangle",
                  label: "data(relationship)",
                  "font-size": "10px",
                  "curve-style": "bezier",
                },
              },
            ],
            layout: {
              name: "cose",
              animate: true,
              nodeRepulsion: 400000,
              idealEdgeLength: 100,
              gravity: 80,
              numIter: 1000,
              fit: true,
              padding: 30,
            },
          });

          cy.on("tap", "node", function (evt) {
            const node = evt.target;
            const data = node.data();
            document.getElementById("node-id").textContent = `ID: ${data.id}`;
            document.getElementById("node-module").textContent = `Module: ${data.module}`;
            document.getElementById("node-description").textContent = `Description: ${data.description}`;
            document.getElementById("node-key").textContent = `Key: ${data.key || "N/A"}`;
          });
        })
        .catch((error) => {
          console.error("Error loading or rendering graph:", error);
          alert("Failed to load graph.json. Check the console for details.");
        });
    });

    function searchNodes() {
      const searchTerm = document.getElementById("search-input").value.trim().toLowerCase();
      if (!searchTerm) {
        cy.nodes().removeClass("highlighted");
        return;
      }

      cy.nodes().removeClass("highlighted");

      const matchedNodes = cy.nodes().filter((node) => {
        const nodeId = node.data("id").toLowerCase();
        return nodeId.includes(searchTerm);
      });

      if (matchedNodes.length > 0) {
        matchedNodes.addClass("highlighted");
        const firstMatch = matchedNodes[0];
        cy.animate({
          center: { eles: firstMatch },
          zoom: 1.5,
          duration: 500,
        });
      } else {
        alert("No nodes found matching: " + searchTerm);
      }
    }

    document.getElementById("search-input").addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        searchNodes();
      }
    });
  </script>
</body>

</html>